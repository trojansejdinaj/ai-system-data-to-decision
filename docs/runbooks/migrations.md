# Migrations Runbook

## Overview

The system uses **Alembic** to manage database schema migrations. Migrations live in `src/app/db/migrations/versions/` and are applied automatically during deployment.

- **Tool:** Alembic (SQLAlchemy migration framework)
- **Location:** `src/app/db/migrations/`
- **Config:** `alembic.ini`
- **Versions:** `src/app/db/migrations/versions/`

---

## Quick Start

### Create a Migration

After modifying SQLAlchemy models in the codebase:

```bash
make revision m="add users table"
```

This generates a new file in `src/app/db/migrations/versions/` with an autogenerated schema diff.

Edit the file if needed, then apply:

```bash
make migrate
```

This runs all pending migrations against the database.

⚠️ **Reliability Note:** The Makefile runs Alembic via Python module (`uv run python -m alembic`), not as a binary on `$PATH`. This avoids `Failed to spawn: alembic` errors from missing or stale installations. Always use `make migrate` / `make revision` in this project.

---

## Creating Migrations

### 1. Modify Your Models

Edit the SQLAlchemy model (e.g., `src/app/db/models.py`):

```python
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.orm import declarative_base
from datetime import datetime

Base = declarative_base()

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    name = Column(String(255), nullable=False)
    email = Column(String(255), unique=True)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 2. Generate the Migration

```bash
make revision m="add users table"
```

Output:
```
Creating migration file: ...versions/abc123def456_add_users_table.py
```

### 3. Review & Edit

Open `src/app/db/migrations/versions/abc123def456_add_users_table.py`:

```python
def upgrade() -> None:
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('email', sa.String(length=255), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('email')
    )

def downgrade() -> None:
    op.drop_table('users')
```

Edit if Alembic's auto-detection missed anything. Then apply.

### 4. Apply the Migration

```bash
make migrate
```

This:
1. Waits for DB readiness (`make db-wait`)
2. Runs `alembic upgrade head`
3. Applies all pending migrations

Check success:

```bash
docker compose exec db psql -U d2d_user -d d2d_db -c "SELECT * FROM alembic_version;"
```

Shows the current migration ID.

---

## Common Patterns

### Add a Column

```python
def upgrade() -> None:
    op.add_column('users', sa.Column('phone', sa.String(20)))

def downgrade() -> None:
    op.drop_column('users', 'phone')
```

### Drop a Column

```python
def upgrade() -> None:
    op.drop_column('users', 'phone')

def downgrade() -> None:
    op.add_column('users', sa.Column('phone', sa.String(20)))
```

### Rename a Table

```python
def upgrade() -> None:
    op.rename_table('old_name', 'new_name')

def downgrade() -> None:
    op.rename_table('new_name', 'old_name')
```

### Add a Foreign Key

```python
def upgrade() -> None:
    op.add_column('orders', sa.Column('user_id', sa.Integer()))
    op.create_foreign_key('fk_orders_user_id', 'orders', 'users', ['user_id'], ['id'])

def downgrade() -> None:
    op.drop_constraint('fk_orders_user_id', 'orders')
    op.drop_column('orders', 'user_id')
```

### Create an Index

```python
def upgrade() -> None:
    op.create_index('idx_users_email', 'users', ['email'])

def downgrade() -> None:
    op.drop_index('idx_users_email', 'users')
```

---

## Viewing Migrations

### List All Migrations

```bash
ls -la src/app/db/migrations/versions/
```

Each file is timestamped and numbered:
```
78b15fee4f9b_init.py
abc123def456_add_users_table.py
```

### Check Current Version

```bash
docker compose exec db psql -U d2d_user -d d2d_db -c "SELECT version_num FROM alembic_version;"
```

Shows the applied migration ID.

### View a Migration File

```bash
cat src/app/db/migrations/versions/abc123def456_add_users_table.py
```

---

## Rollback

### Downgrade to Previous Migration

```bash
uv run alembic downgrade -1
```

This runs the `downgrade()` function of the current migration.

### Downgrade to a Specific Version

```bash
uv run alembic downgrade abc123def456
```

Downgrades to the migration with that ID.

### Downgrade All

```bash
uv run alembic downgrade base
```

Removes all migrations (tables drop). **Warning:** Deletes data!

---

## Troubleshooting

### Migration Fails

Check the error:

```bash
make migrate
```

Look for:
- SQL syntax errors in the migration file
- Missing dependencies (e.g., foreign key target doesn't exist)
- Conflicting constraints

Edit the migration file and re-run.

### Migration File Has Syntax Errors

Edit `src/app/db/migrations/versions/abc123_*.py` to fix:

```python
def upgrade() -> None:
    # Fix your SQL here
    op.execute("YOUR_SQL_HERE")

def downgrade() -> None:
    op.execute("UNDO_SQL_HERE")
```

Then run `make migrate`.

### Database and Code Out of Sync

If the model and DB are misaligned:

1. Check current version: `uv run alembic current`
2. Check migration history: `uv run alembic history`
3. Reset and reapply:
   ```bash
   make db-down
   docker volume rm $(docker volume ls -q | grep d2d)
   make db-up
   make migrate
   ```

### Alembic Can't Find Models

Ensure `src/app/db/` has an `__init__.py` and models are importable:

```bash
python -c "from src.app.db.models import Base; print(Base)"
```

If it fails, check imports in `alembic/env.py`.

---

## Best Practices

1. **Descriptive names:** Use clear messages: `m="add payment_method to invoices"`
2. **Test migrations:** Always test locally before deploying
3. **Keep migrations small:** One logical change per migration
4. **Never edit applied migrations:** If you need to fix it, create a new one
5. **Document complex migrations:** Add comments to `upgrade()` and `downgrade()`
6. **Review diffs:** Check the auto-generated SQL before applying

---

## Next Steps

- See [local dev runbook](./local-dev.md) for setup
- See [database runbook](./database.md) for connection details
- Check [decisions/0004](../decisions/0004-db-readiness.md) for DB readiness strategy
